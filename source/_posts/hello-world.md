---
title: CAN通信基础教程
date: 2024-11-17
tags:
    - 通信
    - 工业网络
Categories: 通信
mathjax: true
---
# CAN通信
# CAN通信基础教程

## 网络拓扑

CAN 通信支持多种网络拓扑结构：

- **总线型**（Bus Topology）：最常见的拓扑结构，设备挂载在一根主总线上，适合点到多点通信。
- **环型**（Ring Topology）：少见，主要用于容错和冗余设计。
- **点对点（P2P Topology）**：简单的两个节点直接相连。
- **星型**（Star Topology）：通过集线器连接多个节点，布线复杂，成本较高。
- **树型**（Tree Topology）：适合分级的通信结构，常见于复杂分布式网络。

## CAN 的历史

CAN 最初由德国 Bosch 公司在 20 世纪 80 年代末提出，专为 **汽车工业**设计，旨在简化车辆电子装置间的通信，减少信号线的数量。

- **背景**：消费者对汽车功能的需求日益增加，导致车内电子设备增多，传统点对点通信需要大量信号线。
- **解决方案**：设计了一种 **单一网络总线**，所有电子设备共享一根总线通信。
- **标准化**：1993 年，CAN 成为国际标准：
  - ISO 11898：高速应用
  - ISO 11519：低速应用

---

## 帧类型

CAN 通信中的帧分为以下几种类型：

1. **数据帧**：广播式发送，主动传输数据。
2. **遥控帧**：请求式发送，接收设备主动请求数据。
3. **错误帧**：设备检测到错误后，向总线发送的错误通知。
4. **过载帧**：接收设备未准备好时，通知发送设备延迟传输。
5. **帧间隔**：用于分隔帧，保证通信的规范性。

---

## 数据帧结构

### 标准格式

#### 1. **空闲状态**

- **隐性电平**（由两个 120 欧姆终端电阻将总线拉至同一电平）。

#### 2. **帧起始（SOF）**

- **SOF（Start Of Frame）**：1 位显性电平 `0`。
- **作用**：打破总线的隐性电平状态，通知设备有消息即将发送。

#### 3. **仲裁段**

- **ID**：11 位
  1. 表示报文的 ID 功能。
  2. 决定优先级，ID 越小，优先级越高。
- **RTR（远程发送请求）**：1 位
  - 显性 `0`：数据帧。
  - 隐性 `1`：遥控帧。

#### 4. **控制段**

- **IDE（标识符扩展位）**：1 位
  - `0`：标准帧。
  - `1`：扩展帧。
- **r0（保留位）**：1 位
  - 为未来扩展预留，当前固定为显性 `0`。
- **DLC（数据长度码）**：4 位
  - 表示数据域长度，范围为 0~8 字节。

#### 5. **数据段**

- 长度由 **DLC** 决定，最大为 8 字节。

#### 6. **CRC段**

- 15 位，用于校验从 SOF 到数据段的完整性。
- **CRC界定符**：1 位隐性电平。

#### 7. **ACK段**

- **ACK 槽**：发送方释放总线，接收方若无错误，则发送显性 `0` 作为应答。
- **ACK 界定符**：1 位隐性电平。

#### 8. **帧结束（EOF）**

- 7 位隐性电平 `1`，标志帧结束

---

### 波形特点

- **发送与接收同步**：CAN 帧波形由发送方和接收方共同完成。接收方实时读取发送方的波形数据，而非等到帧发送完再读取。
- **实时性**：这种同步机制保证了 CAN 的实时性能。

---

## 遥控帧

### 特点

1. 无数据段。
2. **RTR 位**为隐性 `1`（数据帧的 RTR 为显性 `0`）。
3. 主动请求报文的方式适用于数据不频繁的场景。

### 使用场景

- 当广播数据过于频繁会浪费总线资源，且广播过慢时接收方无法及时获取数据。
- 请求方发送遥控帧，ID 表示请求的数据，响应方通过相同 ID 的数据帧反馈数据。

---

## 位填充规则

- 数据帧中，每连续 5 位相同电平后，自动插入 1 位相反电平。
- **作用**：
  1. 防止长时间波形无变化，避免接收方误判。
  2. 区分正常数据流与错误帧或过载帧。
  3. 避免误识别为总线空闲状态。

---
补充：总线空闲指的是连续11个隐性电平，一般是ACK界定符+7为EOF+3位帧间隔
## 仲裁机制：非破坏性总线访问

### 原则

1. **先到先得**：总线空闲后，首先发起的设备占据总线。
2. **非破坏性仲裁**：优先级低的设备自动退出竞争。

### 仲裁规则

- **优先级顺序**：
  1. 报文 ID 小 > 报文 ID 大。
  2. 标准帧 > 扩展帧。
  3. 数据帧 > 遥控帧。

### 回读机制

- 仲裁期间，发送方通过回读自己的发送波形检测是否有冲突。若检测到较高优先级的设备发送数据，低优先级设备退出竞争。

---

## 帧间隔

- 每帧之间需至少包含 3 位隐性电平，用于分隔帧。
- 帧间隔保证了帧的完整性和总线的稳定性。

---